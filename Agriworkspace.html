<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>e-Panta Agriculture Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    body { background: #f4f8fc; min-height: 100vh; }
    .hidden { display: none; }
    .navbar-brand { letter-spacing: 0.03em; font-size: 1.1rem; }
    table.table-bordered thead tr {
      background: #1862ab;
      color: white;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<div id="mainNavbar" class="hidden">
  <nav class="navbar navbar-expand-lg navbar-dark" style="background:#1862ab;">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">GOVERNMENT OF ANDHRA PRADESH DEPARTMENT OF AGRICULTURE</a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link text-white" href="#" onclick="showSection('dashboardSection');return false;">Dashboard</a>
        <a class="nav-link text-white" href="#" onclick="showSection('ePantaReportPage');return false;">e-Panta Report</a>
        <a class="nav-link text-white" href="#" onclick="showSection('eseedSection');return false;">e-Seed Report</a>
        <a class="nav-link text-white" href="#" onclick="showSection('paddyProcurementSection');return false;">Paddy Procurement</a>
        <a class="nav-link text-white" href="#" onclick="showSection('uploadReportPage');return false;">Upload Report</a>
        <a class="nav-link text-white" href="#" onclick="showSection('profileSection');return false;">Profile</a>
        <a class="nav-link text-white" href="#" onclick="logoutUser();return false;">Logout</a>
      </div>
    </div>
  </nav>
</div>

<!-- Login -->
<div class="container" id="loginPage">
  <div class="card shadow p-4 mx-auto" style="max-width: 400px;">
    <h2 class="mb-4 text-center">Login</h2>
    <input id="loginEmail" type="email" class="form-control mb-3" placeholder="Enter your email" />
    <input id="loginPassword" type="password" class="form-control mb-3" placeholder="Enter your password" />
    <button class="btn btn-primary w-100 mb-2" onclick="loginUser()">Login</button>
    <div class="text-center">
      <a href="#" onclick="showSection('resetPasswordSection');return false;">Forgot Password?</a><br />
      <small>New user? <a href="#" onclick="showSection('registerPage');return false;">Register Here</a></small>
    </div>
  </div>
</div>

<!-- Register -->
<div class="container hidden" id="registerPage">
  <div class="card shadow p-4 mx-auto" style="max-width: 400px;">
    <h2 class="mb-4 text-center">Register</h2>
    <input id="registerEmail" type="email" class="form-control mb-3" placeholder="Enter your email" />
    <input id="registerPassword" type="password" class="form-control mb-3" placeholder="Enter your password" />
    <button class="btn btn-success w-100 mb-2" onclick="registerUser()">Register</button>
    <div class="text-center">
      <a href="#" onclick="showSection('loginPage');return false;">Back to Login</a>
    </div>
  </div>
</div>

<!-- Reset Password -->
<div class="container hidden" id="resetPasswordSection">
  <div class="card shadow p-4 mx-auto" style="max-width: 400px;">
    <h2 class="mb-4 text-center">Reset Password</h2>
    <input id="resetEmail" type="email" class="form-control mb-3" placeholder="Enter your email" />
    <button class="btn btn-warning w-100 mb-2" onclick="sendPasswordReset()">Send Reset Email</button>
    <div class="text-center">
      <a href="#" onclick="showSection('loginPage');return false;">Back to Login</a>
    </div>
  </div>
</div>

<!-- Dashboard -->
<div class="container py-5 hidden" id="dashboardSection">
  <h2>Dashboard</h2>
  <p>Welcome, <span id="userEmail"></span></p>
  <div class="container py-5">
    <div class="row row-cols-1 row-cols-md-3 g-4 mb-3">
      <div class="col d-flex">
        <div class="card flex-fill text-center shadow-sm" onclick="showSection('ePantaReportPage')" style="cursor:pointer;">
          <div class="card-body">
            <img src="https://img.icons8.com/color/48/000000/list.png" alt="e-Panta" />
            <h5 class="card-title mt-2">e-Panta</h5>
            <p class="card-text">View the crop booking report</p>
          </div>
        </div>
      </div>
      <div class="col d-flex">
        <div class="card flex-fill text-center shadow-sm" onclick="showSection('eseedSection')" style="cursor:pointer;">
          <div class="card-body">
            <img src="https://img.icons8.com/color/48/000000/plant-under-rain--v2.png" alt="e-Seed" />
            <h5 class="card-title mt-2">e-Seed</h5>
            <p class="card-text">Manage seed information and procurement.</p>
          </div>
        </div>
      </div>
      <div class="col d-flex">
        <div class="card flex-fill text-center shadow-sm" onclick="showSection('paddyProcurementSection')" style="cursor:pointer;">
          <div class="card-body">
            <img src="https://img.icons8.com/color/48/000000/rice-bowl.png" alt="Paddy Procurement" />
            <h5 class="card-title mt-2">Paddy Procurement</h5>
            <p class="card-text">View and manage paddy procurement details.</p>
          </div>
        </div>
      </div>
    </div>
    <div class="row row-cols-1 row-cols-md-2 g-4">
      <div class="col d-flex">
        <div class="card flex-fill text-center shadow-sm" onclick="showSection('profileSection')" style="cursor:pointer;">
          <div class="card-body">
            <img src="https://img.icons8.com/ios-filled/50/000000/user.png" alt="Profile" />
            <h5 class="card-title mt-2">Profile</h5>
            <p class="card-text">View and update profile information.</p>
          </div>
        </div>
      </div>
      <div class="col d-flex">
        <div class="card flex-fill text-center shadow-sm" onclick="showSection('uploadReportPage')" style="cursor:pointer;">
          <div class="card-body">
            <img src="https://img.icons8.com/office/48/000000/upload.png" alt="Upload Report" />
            <h5 class="card-title mt-2">Upload Report</h5>
            <p class="card-text">Consolidate farmers and booking data from Excel/CSV files.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Report -->
<div class="container hidden" id="uploadReportPage">
  <div class="card p-4 mx-auto mt-4" style="max-width: 960px;">
    <h2>Upload Farmer / Booking Report (.csv or .xlsx)</h2>
    <div>
      <label for="cropYear">Crop Year:</label>
      <select id="cropYear"></select>
      <label for="season">Season:</label>
      <select id="season">
        <option value="">Select</option>
        <option value="Kharif">Kharif</option>
        <option value="Rabi">Rabi</option>
        <option value="Summer">Summer</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" aria-label="Upload Excel or CSV file" />
    <div id="message" role="alert"></div>
    <div id="previewHeading" style="display:none;">Preview of Uploaded Data</div>
    <div id="summary" class="summary" aria-live="polite"></div>
    <div id="tableContainer" tabindex="0" aria-label="Data Table Container" style="overflow:auto; max-height: 400px;">
      <table id="dataTable" aria-describedby="summary"></table>
    </div>
    <button id="saveSummaryBtn">Save &amp; View in e-Panta Report</button>
  </div>
</div>

<!-- e-Panta Report -->
<div class="container hidden" id="ePantaReportPage">
  <h2>e-Panta Crop Booking Report</h2>
  <div>
    <label for="filterYear">Select Crop Year:</label>
    <select id="filterYear"><option value="">--Choose Year--</option></select>
    <label for="filterSeason">Select Season:</label>
    <select id="filterSeason">
      <option value="">--Choose Season--</option>
      <option value="Kharif">Kharif</option>
      <option value="Rabi">Rabi</option>
      <option value="Summer">Summer</option>
      <option value="Other">Other</option>
    </select>
    <button id="loadReportBtn">Load Report</button>
  </div>
  <div id="reportContainer" style="margin-top:1.5rem;"></div>
</div>

<!-- Farmer Details Page -->
<div class="container hidden" id="farmerDetailsPage">
  <h2 id="farmerDetailsTitle"></h2>
  <button class="btn btn-secondary mb-3" id="fdBackBtn">← Back to e-Panta Report</button>
  <div id="farmerDetailsContent"></div>
</div>

<!-- Crop Farmers Page -->
<div class="container hidden" id="cropFarmersPage">
  <h2 id="cropFarmersTitle"></h2>
  <button class="btn btn-secondary mb-3" id="cfBackBtn">← Back to e-Panta Report</button>
  <div id="cropFarmersContent"></div>
</div>

<!-- e-Seed Report placeholder -->
<div class="container hidden" id="eseedSection"></div>

<!-- Paddy Procurement placeholder -->
<div class="container hidden" id="paddyProcurementSection"></div>

<!-- Profile Section -->
<div class="container hidden" id="profileSection">
  <h2>Profile</h2>
  <div class="card p-4 mx-auto" style="max-width: 400px;">
    <form id="profileForm" aria-label="User Profile Form">
      <div class="mb-3">
        <label for="profileEmail" class="form-label">Email</label>
        <input type="email" id="profileEmail" class="form-control" readonly />
      </div>
      <div class="mb-3">
        <label for="profileDisplayName" class="form-label">Display Name</label>
        <input type="text" id="profileDisplayName" class="form-control" placeholder="Enter display name" />
      </div>
      <button id="updateProfileBtn" type="submit" class="btn btn-primary w-100 mb-3">Update Profile</button>
    </form>
    <hr />
    <h4>Change Password</h4>
    <form id="changePasswordForm" aria-label="Change Password Form">
      <div class="mb-3">
        <label for="currentPassword" class="form-label">Current Password</label>
        <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password" required />
      </div>
      <div class="mb-3">
        <label for="newPassword" class="form-label">New Password</label>
        <input type="password" id="newPassword" class="form-control" placeholder="Enter new password" required />
      </div>
      <div class="mb-3">
        <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
        <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password" required />
      </div>
      <button type="submit" class="btn btn-warning w-100">Change Password</button>
    </form>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD67V05oD0VRpRITR0z0R61NqIfuaiFih4",
  authDomain: "agri-work-space.firebaseapp.com",
  databaseURL: "https://agri-work-space-default-rtdb.firebaseio.com",
  projectId: "agri-work-space",
  storageBucket: "agri-work-space.firebasestorage.app",
  messagingSenderId: "13945141436",
  appId: "1:13945141436:web:0eacfa11b7a0e864bb38b9",
  measurementId: "G-F7E4H3EVQY"
};
firebase.initializeApp(firebaseConfig);

let parsedExcelData = null;

function sanitizeKeys(obj) {
  let clean = {};
  for (let k in obj) {
    let newKey = k.replace(/[.#$/\[\]]/g, '_');
    clean[newKey] = obj[k];
  }
  return clean;
}

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('mainNavbar').classList.remove('hidden');
    showSection('dashboardSection');
    populateYearDropdowns();
  } else {
    document.getElementById('mainNavbar').classList.add('hidden');
    showSection('loginPage');
  }
});

function showSection(section) {
  const sections = ['dashboardSection', 'uploadReportPage', 'ePantaReportPage', 'eseedSection', 'paddyProcurementSection', 'farmerDetailsPage', 'cropFarmersPage', 'loginPage', 'registerPage', 'resetPasswordSection', 'profileSection'];
  sections.forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById(section).classList.remove('hidden');
}

function loginUser() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  firebase.auth().signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
}

function registerUser() {
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  firebase.auth().createUserWithEmailAndPassword(email, password)
    .then(() => alert('Registration successful! Please login.'))
    .catch(e => alert(e.message));
}

function logoutUser() {
  firebase.auth().signOut().then(() => showSection('loginPage'));
}

function sendPasswordReset() {
  const email = document.getElementById('resetEmail').value;
  if (!email) { alert('Please enter your email.'); return; }
  firebase.auth().sendPasswordResetEmail(email)
    .then(() => { alert('Password reset email sent!'); showSection('loginPage'); })
    .catch(e => alert(e.message));
}

function getStorageKey() {
  const user = firebase.auth().currentUser;
  return user ? user.email + '_allReports' : 'allReports';
}

function populateYearDropdowns() {
  const filterYear = document.getElementById('filterYear');
  const cropYear = document.getElementById('cropYear');
  [filterYear, cropYear].forEach(sel => {
    sel.innerHTML = '<option value="">--Choose Year--</option>';
    for(let year = 2020; year <= new Date().getFullYear(); year++) {
      sel.appendChild(new Option(year, year));
    }
  });
}

const fileInput = document.getElementById('fileInput');
let uploadData = [];

fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) {
    document.getElementById('message').textContent = 'No file selected.';
    return;
  }
  document.getElementById('message').textContent = '';
  const previewHeading = document.getElementById('previewHeading');
  previewHeading.style.display = 'none';
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
      if(jsonData.length === 0) {
        document.getElementById('message').textContent = 'File is empty or invalid.';
        return;
      }
      uploadData = jsonData;
      previewHeading.style.display = 'block';
      displayUploadedDataTable(jsonData);
      summarizeUploadedData(jsonData);
    } catch(err) {
      document.getElementById('message').textContent = 'Error processing file: ' + err.message;
    }
  };
  reader.readAsArrayBuffer(file);
});

function escapeHtml(text) {
  if (!text) return '';
  return text.toString().replace(/&/g, '&amp;')
    .replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}

function displayUploadedDataTable(data) {
  const table = document.getElementById('dataTable');
  if(data.length === 0) { 
    table.innerHTML = ''; 
    return; 
  }
  const cols = Object.keys(data[0]);
  let html = '<thead><tr>';
  cols.forEach(c => html += `<th>${escapeHtml(c)}</th>`);
  html += '</tr></thead><tbody>';
  data.forEach(row => {
    html += '<tr>';
    cols.forEach(c => html += `<td>${escapeHtml(row[c])}</td>`);
    html += '</tr>';
  });
  html += '</tbody>';
  table.innerHTML = html;
}

function summarizeUploadedData(data){
  let uniqueFarmers = new Set(), totalArea = 0, cropMap = {};
  data.forEach(row => {
    const aadhaar = (row['Aadhaar Number'] || '').toString().trim();
    const name = (row['Farmer Name'] || '').toString().trim();
    const village = (row['Village'] || '').toString().trim();
    const crop = (row['Crop Name'] || '').toString().trim();
    let area = Number(row['Area']) || 0;
    totalArea += area;
    const key = aadhaar || (name + '|' + village);
    uniqueFarmers.add(key);
    cropMap[crop] = cropMap[crop] || {farmers: new Set(), area: 0};
    cropMap[crop].farmers.add(key);
    cropMap[crop].area += area;
  });
  let summaryHTML = `
    <p>Total Unique Farmers: <strong>${uniqueFarmers.size}</strong></p>
    <p>Total Area: <strong>${totalArea.toFixed(2)}</strong></p>
    <h4>Crop Details:</h4>
    <table class="table table-bordered">
      <thead>
        <tr style="background:#1862ab; color:#fff;">
          <th>Crop Name</th><th>Unique Farmers</th><th>Area</th>
        </tr>
      </thead>
      <tbody>
  `;
  let grandArea = 0;
  Object.entries(cropMap).forEach(([crop, val]) => {
    grandArea += val.area;
    summaryHTML += `<tr><td>${escapeHtml(crop)}</td><td>${val.farmers.size}</td><td>${val.area.toFixed(2)}</td></tr>`;
  });
  summaryHTML += `<tr style="font-weight:bold; background:#eee;">
    <td colspan="2" style="text-align:right;">Total</td><td>${grandArea.toFixed(2)}</td>
    </tr>`;
  summaryHTML += '</tbody></table>';
  document.getElementById('summary').innerHTML = summaryHTML;
}

document.getElementById('saveSummaryBtn').addEventListener('click', e => {
  e.preventDefault();
  const cropYear = document.getElementById('cropYear').value;
  const season = document.getElementById('season').value;
  if(!cropYear || !season) { alert('Select Crop Year and Season'); return; }
  if(uploadData.length === 0) { alert('No data to save. Please upload a report.'); return; }
  
  let reports = JSON.parse(localStorage.getItem(getStorageKey()) || '{}');
  let farmersSet = new Set(), farmerDetails = {}, cropsSummary = {};

  uploadData.forEach(row => {
    const aadhaar = (row['Aadhaar Number'] || '').toString().trim();
    const farmerName = (row['Farmer Name'] || '').toString().trim();
    const fatherName = (row['Father Name'] || '').toString().trim();
    const village = (row['Village'] || '').toString().trim();
    const cropName = (row['Crop Name'] || '').toString().trim();
    const bookingID = (row['Booking ID'] || '').toString().trim();
    const khathaNo = (row['Khatha Number'] || '').toString().trim();
    const surveyNo = (row['Survey Number'] || '').toString().trim();
    const area = Number(row['Area']) || 0;

    const farmerKey = aadhaar || (farmerName + '|' + village);
    farmersSet.add(farmerKey);

    farmerDetails[farmerKey] = farmerDetails[farmerKey] || [];
    farmerDetails[farmerKey].push({bookingID, khathaNo, surveyNo, cropName, area});
    
    cropsSummary[cropName] = cropsSummary[cropName] || {farmers: new Set(), area: 0};
    cropsSummary[cropName].farmers.add(farmerKey);
    cropsSummary[cropName].area += area;
  });

  const uniqueFarmersList = Array.from(farmersSet).map(key => {
    const first = uploadData.find(r => (r['Aadhaar Number'] || '').toString().trim() === key || (r['Farmer Name'] + '|' + r['Village']) === key);
    return {
      farmerName: (first && first['Farmer Name']) || '(Unknown)',
      fatherName: (first && first['Father Name']) || '',
      aadhaarNumber: (first && first['Aadhaar Number']) || '-',
      village: (first && first['Village']) || ''
    };
  });

  const totalArea = Object.values(cropsSummary).reduce((sum, c) => sum + c.area, 0);

  const cropsArray = Object.entries(cropsSummary).map(([cropName, val]) => ({
    cropName, uniqueFarmers: val.farmers.size, areaSown: val.area
  }));

  const key = cropYear + '_' + season;
  reports[key] = { 
    summary: {totalFarmers: farmersSet.size, totalArea: totalArea, crops:cropsArray}, 
    uniqueFarmers: uniqueFarmersList, 
    farmerDetails: farmerDetails 
  };

  localStorage.setItem(getStorageKey(), JSON.stringify(reports));

  alert(`Report saved for Crop Year: ${cropYear} and Season: ${season}`);

  showSection('ePantaReportPage');
  document.getElementById('filterYear').value = cropYear;
  document.getElementById('filterSeason').value = season;
  loadReport();
});

document.getElementById('loadReportBtn').addEventListener('click', loadReport);

function loadReport() {
  const year = document.getElementById('filterYear').value;
  const season = document.getElementById('filterSeason').value;
  if(!year) { alert('Please select Crop Year'); return; }
  if(!season) { alert('Please select Season'); return; }
  const reports = JSON.parse(localStorage.getItem(getStorageKey()) || '{}');
  const key = year + '_' + season;
  const report = reports[key];

  const reportContainer = document.getElementById('reportContainer');
  if(!report) {
    reportContainer.innerHTML = `<p>No report found for Crop Year ${year} and Season ${season}.</p>`;
    return;
  }

  let html = `<div>
    <p><strong>Total Unique Farmers:</strong> ${report.summary.totalFarmers}</p>
    <p><strong>Total Area:</strong> ${report.summary.totalArea.toFixed(2)}</p>
  </div>
  <h3>Crop-wise Details</h3>
  <table class="table table-bordered">
    <thead>
      <tr style="background:#1862ab; color:#fff;">
        <th>Crop Name</th>
        <th>Unique Farmers</th>
        <th>Area</th>
      </tr>
    </thead>
    <tbody>`;
  report.summary.crops.forEach(crop => {
    html += `<tr>
      <td><button type="button" class="crop-btn btn btn-link p-0" data-crop="${encodeURIComponent(crop.cropName)}">${escapeHtml(crop.cropName)}</button></td>
      <td>${crop.uniqueFarmers}</td>
      <td>${crop.areaSown.toFixed(2)}</td>
    </tr>`;
  });
  html += `</tbody></table>
  <h3>Farmers</h3>
  <table class="table table-bordered">
    <thead>
      <tr style="background:#1862ab; color:#fff;">
        <th>Farmer Name</th>
        <th>Father Name</th>
        <th>Aadhaar Number</th>
        <th>Village</th>
      </tr>
    </thead>
    <tbody>`;
  report.uniqueFarmers.forEach(farmer => {
    const farmerKey = farmer.aadhaarNumber !== '-' ? farmer.aadhaarNumber : `${farmer.farmerName}|${farmer.village || ''}`;
    html += `<tr>
      <td><button type="button" class="farmer-btn btn btn-link p-0" data-key="${encodeURIComponent(farmerKey)}">${escapeHtml(farmer.farmerName)}</button></td>
      <td>${escapeHtml(farmer.fatherName)}</td>
      <td>${escapeHtml(farmer.aadhaarNumber)}</td>
      <td>${escapeHtml(farmer.village)}</td>
    </tr>`;
  });
  html += '</tbody></table>';

  reportContainer.innerHTML = html;

  // Attach event handlers for crop buttons
  document.querySelectorAll('.crop-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      sessionStorage.setItem('selectedCropName', decodeURIComponent(btn.dataset.crop));
      sessionStorage.setItem('selectedReportKey', key);
      showCropFarmersPage();
    });
  });

  // Attach event handlers for farmer buttons
  document.querySelectorAll('.farmer-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      sessionStorage.setItem('selectedFarmerKey', decodeURIComponent(btn.dataset.key));
      sessionStorage.setItem('selectedReportKey', key);
      showFarmerDetailsPage();
    });
  });
}

function showCropFarmersPage() {
  showSection('cropFarmersPage');
  const reportKey = sessionStorage.getItem('selectedReportKey');
  const cropName = sessionStorage.getItem('selectedCropName');
  const titleEl = document.getElementById('cropFarmersTitle');
  const contentEl = document.getElementById('cropFarmersContent');
  if(!reportKey || !cropName) {
    titleEl.textContent = 'Crop Farmers';
    contentEl.innerHTML = '<p>No crop specified.</p>';
    return;
  }
  const reports = JSON.parse(localStorage.getItem(getStorageKey()) || '{}');
  const report = reports[reportKey];
  if(!report) {
    titleEl.textContent = 'Crop Farmers';
    contentEl.innerHTML = '<p>No report data available.</p>';
    return;
  }
  titleEl.textContent = `Farmers for Crop: ${cropName}`;
  let html = '<table class="table table-bordered"><thead><tr><th>Farmer Name</th><th>Father Name</th><th>Total Area</th></tr></thead><tbody>';
  let totalArea = 0;
  report.uniqueFarmers.forEach(farmer => {
    const farmerKey = farmer.aadhaarNumber !== '-' ? farmer.aadhaarNumber : (farmer.farmerName + '|' + (farmer.village || ''));
    const details = report.farmerDetails[farmerKey] || [];
    const cropArea = details.filter(d => d.cropName === cropName).reduce((a,d) => a + Number(d.area || 0), 0);
    if(cropArea > 0) {
      html += `<tr><td>${escapeHtml(farmer.farmerName)}</td><td>${escapeHtml(farmer.fatherName)}</td><td>${cropArea.toFixed(2)}</td></tr>`;
      totalArea += cropArea;
    }
  });
  html += `<tr style="font-weight:bold;background:#eee;"><td colspan="2" style="text-align:right;">Total</td><td>${totalArea.toFixed(2)}</td></tr></tbody></table>`;
  contentEl.innerHTML = html;
}
document.getElementById('cfBackBtn').addEventListener('click', () => {
  showSection('ePantaReportPage');
  const key = sessionStorage.getItem('selectedReportKey');
  if(key) {
    const [year, season] = key.split('_');
    document.getElementById('filterYear').value = year;
    document.getElementById('filterSeason').value = season;
    loadReport();
  }
});

function showFarmerDetailsPage() {
  showSection('farmerDetailsPage');
  const reportKey = sessionStorage.getItem('selectedReportKey');
  const farmerKey = sessionStorage.getItem('selectedFarmerKey');
  const title = document.getElementById('farmerDetailsTitle');
  const content = document.getElementById('farmerDetailsContent');
  if(!reportKey || !farmerKey) {
    title.textContent = 'Farmer Cultivation Details';
    content.innerHTML = '<p>No farmer details available.</p>';
    return;
  }
  const reports = JSON.parse(localStorage.getItem(getStorageKey()) || '{}');
  const report = reports[reportKey];
  if(!report) {
    title.textContent = 'Farmer Cultivation Details';
    content.innerHTML = '<p>No report data available.</p>';
    return;
  }
  const details = report.farmerDetails[farmerKey] || [];
  if(!details.length){
    title.textContent = 'Farmer Cultivation Details';
    content.innerHTML = '<p>No cultivation details found for this farmer.</p>';
    return;
  }
  let farmerName = '(Unknown)';
  const uf = report.uniqueFarmers.find(f => {
    return ((f.aadhaarNumber && f.aadhaarNumber !== '-') ? f.aadhaarNumber : (f.farmerName + '|' + (f.village || ''))) === farmerKey;
  });
  if(uf) farmerName = uf.farmerName;
  title.textContent = `Cultivation Details for Farmer: ${farmerName}`;
  let html = `<table class="table table-bordered table-striped">
    <thead><tr><th>Booking ID</th><th>Khatha Number</th><th>Survey Number</th><th>Crop Name</th><th>Area</th></tr></thead><tbody>`;
  details.forEach(d => {
    html += `<tr>
      <td>${escapeHtml(d.bookingID || '-')}</td>
      <td>${escapeHtml(d.khathaNo || '-')}</td>
      <td>${escapeHtml(d.surveyNo || '-')}</td>
      <td>${escapeHtml(d.cropName || '-')}</td>
      <td>${d.area.toFixed(2)}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  content.innerHTML = html;
}

document.getElementById('fdBackBtn').addEventListener('click', () => {
  showSection('ePantaReportPage');
  const key = sessionStorage.getItem('selectedReportKey');
  if(key) {
    const [year, season] = key.split('_');
    document.getElementById('filterYear').value = year;
    document.getElementById('filterSeason').value = season;
    loadReport();
  }
});

/* ===== PROFILE SECTION JS ===== */

// Load user profile data on profile section load
function loadUserProfile() {
  const user = firebase.auth().currentUser;
  if (!user) return;
  document.getElementById('profileEmail').value = user.email || '';
  document.getElementById('profileDisplayName').value = user.displayName || '';
}

// Update profile display name
document.getElementById('profileForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const displayName = document.getElementById('profileDisplayName').value.trim();
  const user = firebase.auth().currentUser;
  if (!user) {
    alert('No user is logged in.');
    return;
  }
  try {
    await user.updateProfile({ displayName });
    alert('Profile updated successfully!');
  } catch (error) {
    alert('Error updating profile: ' + error.message);
  }
});

// Change password handler
document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmNewPassword = document.getElementById('confirmNewPassword').value;

  if (newPassword !== confirmNewPassword) {
    alert('New password and confirmation do not match.');
    return;
  }
  if (newPassword.length < 6) {
    alert('New password should be at least 6 characters long.');
    return;
  }

  const user = firebase.auth().currentUser;
  if (!user || !user.email) {
    alert('No user is logged in.');
    return;
  }

  const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);

  try {
    await user.reauthenticateWithCredential(credential);
  } catch (err) {
    alert('Current password is incorrect.');
    return;
  }

  try {
    await user.updatePassword(newPassword);
    alert('Password changed successfully!');
    document.getElementById('changePasswordForm').reset();
  } catch (error) {
    alert('Error changing password: ' + error.message);
  }
});

// Override showSection to load profile data when profile section is shown
const originalShowSection = showSection;
showSection = function(section) {
  originalShowSection(section);
  if (section === 'profileSection') {
    loadUserProfile();
  }
};

</script>

</body>
</html>
