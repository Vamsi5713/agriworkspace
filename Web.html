<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dept. of Agriculture Dashboard</title>
<style>
  /* --- Styles --- */
  body { font-family: Arial, sans-serif; background: #f4f7fa; margin: 0; padding: 0; }
  nav, header {
    background: #2166c3; color: white; padding: 0.75rem 1rem;
    font-weight: bold; letter-spacing: 1px; user-select: none;
    display: flex; align-items: center;
  }
  nav a {
    color: white; margin-right: 1.2rem; text-decoration: none;
    font-weight: bold; cursor: pointer; user-select: none;
  }
  nav a:hover,
  nav a[aria-current="page"] {
    text-decoration: underline;
  }
  main {
    max-width: 960px; margin: 1rem auto; padding: 0 1rem;
  }
  .hidden { display: none; }
  /* Login styles */
  #loginPage {
    max-width: 350px; margin: 4rem auto; background: white;
    padding: 2rem 3rem; border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
  }
  #loginPage h2 {
    color: #2166c3; margin-bottom: 1.5rem;
  }
  #loginPage input {
    width: 100%; padding: 0.8rem;
    margin: 0.5rem 0 1.2rem;
    border: 1px solid #ccc; border-radius: 4px;
    font-size: 1rem;
  }
  #loginPage button {
    background: #2166c3; color: white;
    border: none; border-radius: 4px;
    padding: 0.8rem; width: 100%;
    cursor: pointer; font-size: 1rem;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  #loginPage button:hover {
    background: #184e8a;
  }
  #loginError {
    color: red; margin-bottom: 1rem;
    display: none;
    font-weight: bold;
  }
  /* Dashboard styles */
  #dashboardPage header {
    font-size: 1.5rem; padding: 1.5rem; text-align: center;
  }
  #dashboardTiles {
    display: flex; flex-wrap: wrap;
    justify-content: center; gap: 1.5rem;
    margin-top: 2rem;
  }
  /* Search box wrapper in dashboard */
  #dashboardSearchWrapper {
    max-width: 960px; margin: 1rem auto 0 auto; padding: 0 1rem;
    text-align: center;
  }
  #aadhaarSearchInput {
    width: 260px;
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #ccc;
    margin-bottom: 0.5rem;
  }
  /* Search result table */
  #searchResults {
    margin: 1rem auto;
    max-width: 960px;
    overflow-x: auto;
  }
  #searchResults table {
    width: 100%;
    border-collapse: collapse;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    font-size: 1rem;
  }
  #searchResults th, #searchResults td {
    border: 1px solid #ddd;
    padding: 0.6rem 1rem;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #searchResults th {
    background-color: #2166c3;
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  tbody tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  /* Tiles */
  .tile {
    background: white; width: 220px;
    padding: 1.5rem; border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    cursor: pointer; user-select: none;
    display: flex; flex-direction: column;
    justify-content: center;
    transition: box-shadow 0.3s ease;
  }
  .tile:hover {
    box-shadow: 0 4px 18px rgba(33,102,195,0.4);
  }
  .tile-icon {
    font-size: 3rem; color: #2166c3;
    margin-bottom: 1rem;
    user-select: none;
  }
  .tile-title {
    font-size: 1.25rem; color: #2166c3;
    margin-bottom: 0.5rem;
  }
  .tile-desc {
    color: #555;
  }
  /* General tables */
  table {
    width: 100%; border-collapse: collapse;
    margin-top: 1rem; font-size: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 6px; overflow: hidden;
  }
  th, td {
    border: 1px solid #ddd; padding: 0.75rem 1rem;
    text-align: left;
    white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis;
  }
  th {
    background-color: #2166c3; color: white;
    position: sticky; top: 0; z-index: 1;
  }
  #tableContainer {
    max-height: 400px;
    overflow-y: auto; overflow-x: auto;
    border: 1px solid #ccc; border-radius: 4px;
  }
  .summary {
    margin-top: 1.5rem;
    font-weight: bold;
    font-size: 1.1rem;
    color: #2166c3;
    text-align: center;
  }
  /* Form controls */
  label { margin-right: 0.5rem; font-weight: bold; }
  input[type="number"], select {
    padding: 4px 6px; margin-right: 1rem; min-width: 110px;
  }
  button {
    margin-top: 1.5rem;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    color: white;
    background-color: #2166c3;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  button:hover { background-color: #184e8a; }
  nav { display: flex; gap: 1rem; flex-wrap: wrap; }
  /* Farmer and crop buttons */
  .farmerNameBtn, .cropNameBtn {
    background: none;
    border: none;
    color: #2166c3;
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
    font-size: inherit;
    font-family: inherit;
  }
  .farmerNameBtn:focus, .cropNameBtn:focus {
    outline: 2px solid #184e8a;
    outline-offset: 2px;
  }
  /* Responsive */
  table, th, td {
    min-width: 120px;
  }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<section id="loginPage">
  <h2>Department Login</h2>
  <div id="loginError" role="alert" style="display:none;">Invalid username or password</div>
  <form id="loginForm" novalidate>
    <input id="username" type="text" placeholder="Username" autocomplete="username" required />
    <input id="password" type="password" placeholder="Password" autocomplete="current-password" required />
    <button type="submit" aria-label="Log in">Log In</button>
  </form>
</section>

<!-- DASHBOARD PAGE -->
<section id="dashboardPage" class="hidden" tabindex="-1" aria-label="Dashboard">
  <nav>
    <a href="#" id="navDashboard" aria-current="page">Dashboard</a>
    <a href="#" id="navEPanta">e-Panta Report</a>
    <a href="#" id="navUploadReport">Upload Report</a>
    <a href="#" id="navLogout">Logout</a>
  </nav>
  <header>GOVERNMENT OF ANDHRA PRADESH DEPARTMENT OF AGRICULTURE</header>

  <!-- Search input -->
  <div id="dashboardSearchWrapper" aria-label="Search farmers by last four digits of Aadhaar">
    <input
      type="text"
      id="aadhaarSearchInput"
      placeholder="Search farmers by Aadhaar last 4 digits"
      maxlength="4"
      aria-describedby="searchHelp"
      autocomplete="off"
      inputmode="numeric"
      pattern="[0-9]*"
    />
    <div id="searchHelp" style="color:#555; font-size:0.9rem; margin-top:0.15rem;">Enter last 4 digits of Aadhaar Number</div>
  </div>
  <div id="searchResults" aria-live="polite"></div>

  <!-- Dashboard Tiles -->
  <main id="dashboardTiles" role="main">
    <div class="tile" id="tileEPanta" tabindex="0" role="button" aria-label="Go to e-Panta report">
      <div class="tile-icon" aria-hidden="true">üì±</div>
      <div class="tile-title">e-Panta</div>
      <div class="tile-desc">View the crop booking report</div>
    </div>
    <div class="tile" id="tileESeed" tabindex="0" role="button" aria-label="Go to e-Seed">
      <div class="tile-icon" aria-hidden="true">üå±</div>
      <div class="tile-title">e-Seed</div>
      <div class="tile-desc">Manage seed information and procurement.</div>
    </div>
    <div class="tile" id="tilePaddyProc" tabindex="0" role="button" aria-label="Go to Paddy Procurement">
      <div class="tile-icon" aria-hidden="true">üåæ</div>
      <div class="tile-title">Paddy Procurement</div>
      <div class="tile-desc">View and manage paddy procurement details.</div>
    </div>
    <div class="tile" id="tileProfile" tabindex="0" role="button" aria-label="Go to Profile">
      <div class="tile-icon" aria-hidden="true">üë§</div>
      <div class="tile-title">Profile</div>
      <div class="tile-desc">View and update your profile information.</div>
    </div>
    <div class="tile" id="tileUploadReport" tabindex="0" role="button" aria-label="Go to Upload Report">
      <div class="tile-icon" aria-hidden="true">üìÑ</div>
      <div class="tile-title">Upload Report</div>
      <div class="tile-desc">Consolidate farmers and booking data from Excel/CSV files.</div>
    </div>
  </main>
</section>

<!-- UPLOAD REPORT PAGE -->
<section id="uploadReportPage" class="hidden" tabindex="-1" aria-label="Upload Report">
  <nav>
    <a href="#" id="upNavDashboard">Dashboard</a>
    <a href="#" id="upNavEPanta">e-Panta Report</a>
    <a href="#" id="upNavUploadReport" aria-current="page">Upload Report</a>
    <a href="#" id="upNavLogout">Logout</a>
  </nav>
  <main>
    <h2>Upload Farmer / Booking Report (.csv or .xlsx)</h2>
    <div>
      <label for="cropYear">Crop Year:</label>
      <select id="cropYear" required></select>
      <label for="season">Season:</label>
      <select id="season" required>
        <option value="">Select</option>
        <option value="Kharif">Kharif</option>
        <option value="Rabi">Rabi</option>
        <option value="Summer">Summer</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" aria-label="Upload Excel or CSV file" />
    <div id="message" role="alert"></div>
    <div id="summary" class="summary" aria-live="polite"></div>
    <div id="tableContainer" tabindex="0" aria-label="Data Table Container">
      <table id="dataTable" aria-describedby="summary"></table>
    </div>
    <button id="saveSummaryBtn" aria-label="Save summary and view e-Panta report">Save &amp; View in e-Panta Report</button>
  </main>
</section>

<!-- E-PANTA REPORT PAGE -->
<section id="ePantaReportPage" class="hidden" tabindex="-1" aria-label="e-Panta Report">
  <nav>
    <a href="#" id="repNavDashboard">Dashboard</a>
    <a href="#" id="repNavEPanta" aria-current="page">e-Panta Report</a>
    <a href="#" id="repNavUploadReport">Upload Report</a>
    <a href="#" id="repNavLogout">Logout</a>
  </nav>
  <main>
    <h2>e-Panta Crop Booking Report</h2>
    <div>
      <label for="filterYear">Select Crop Year:</label>
      <select id="filterYear"><option value="">--Choose Year--</option></select>
      <label for="filterSeason">Select Season:</label>
      <select id="filterSeason">
        <option value="">--Choose Season--</option>
        <option value="Kharif">Kharif</option>
        <option value="Rabi">Rabi</option>
        <option value="Summer">Summer</option>
        <option value="Other">Other</option>
      </select>
      <button id="loadReportBtn">Load Report</button>
    </div>
    <div id="reportContainer" style="margin-top:1.5rem;"></div>
  </main>
</section>

<!-- FARMER DETAILS PAGE -->
<section id="farmerDetailsPage" class="hidden" tabindex="-1" aria-label="Farmer Cultivation Details">
  <nav>
    <a href="#" id="fdNavDashboard">Dashboard</a>
    <a href="#" id="fdNavEPanta">e-Panta Report</a>
    <a href="#" id="fdNavUploadReport">Upload Report</a>
    <a href="#" id="fdNavLogout">Logout</a>
  </nav>
  <main>
    <h2 id="farmerDetailsTitle">Farmer Cultivation Details</h2>
    <div id="farmerDetailsContent"></div>
    <button id="fdBackBtn" aria-label="Back to e-Panta Report">‚Üê Back to Report</button>
  </main>
</section>

<!-- CROP FARMERS PAGE -->
<section id="cropFarmersPage" class="hidden" tabindex="-1" aria-label="Crop Farmer Details">
  <nav>
    <a href="#" id="cfNavDashboard">Dashboard</a>
    <a href="#" id="cfNavEPanta">e-Panta Report</a>
    <a href="#" id="cfNavUploadReport">Upload Report</a>
    <a href="#" id="cfNavLogout">Logout</a>
  </nav>
  <main>
    <h2 id="cropFarmersTitle">Crop Farmers</h2>
    <div id="cropFarmersContent"></div>
    <button id="cfBackBtn" aria-label="Back to e-Panta Report">‚Üê Back to Report</button>
  </main>
</section>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  function escapeHtml(text) {
    if (!text) return '';
    return text.toString()
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function showPage(id) {
    ['loginPage', 'dashboardPage', 'uploadReportPage', 'ePantaReportPage', 'farmerDetailsPage', 'cropFarmersPage'].forEach(page => {
      document.getElementById(page).classList.toggle('hidden', page !== id);
    });
    let mainContent = document.querySelector(`#${id} main`) || document.getElementById(id);
    if(mainContent) mainContent.focus();
  }

  function populateYearDropdown(selId, defaultOpt) {
    const sel = document.getElementById(selId);
    sel.innerHTML = '';
    const firstOption = document.createElement('option');
    firstOption.value = "";
    firstOption.textContent = defaultOpt || '--Choose Year--';
    sel.appendChild(firstOption);
    const start = 2020, end = new Date().getFullYear();
    for(let y = start; y <= end; y++) {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      sel.appendChild(opt);
    }
  }

  // LOGIN Implementation
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');

  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    if(username === 'agriadmin' && password === 'GoAndhra2025') {
      localStorage.setItem('loggedIn', 'yes');
      loginError.style.display = 'none';
      showDashboard();
    } else {
      loginError.style.display = 'block';
      document.getElementById('username').focus();
    }
  });

  function showDashboard() { showPage('dashboardPage'); }

  function logout() {
    localStorage.removeItem('loggedIn');
    alert('Logged out successfully.');
    showPage('loginPage');
  }

  ['navLogout','upNavLogout','repNavLogout','fdNavLogout','cfNavLogout'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('click', e => { e.preventDefault(); logout(); });
  });
  ['navDashboard','upNavDashboard','repNavDashboard','fdNavDashboard','cfNavDashboard'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('click', e => { e.preventDefault(); showDashboard(); });
  });
  ['navEPanta','upNavEPanta','repNavEPanta','fdNavEPanta','cfNavEPanta'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('click', e => { e.preventDefault(); showEPantaReport(); });
  });
  ['navUploadReport','upNavUploadReport','repNavUploadReport','fdNavUploadReport','cfNavUploadReport'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('click', e => { e.preventDefault(); showUploadReport(); });
  });

  document.getElementById('tileEPanta').addEventListener('click', showEPantaReport);
  document.getElementById('tileESeed').addEventListener('click', () => alert('Redirecting to e-Seed portal...'));
  document.getElementById('tilePaddyProc').addEventListener('click', () => alert('Redirecting to Paddy Procurement portal...'));
  document.getElementById('tileProfile').addEventListener('click', () => alert('Redirecting to Profile page...'));
  document.getElementById('tileUploadReport').addEventListener('click', showUploadReport);

  document.querySelectorAll('.tile').forEach(tile => {
    tile.addEventListener('keydown', e => {
      if(e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        tile.click();
      }
    });
  });

  // Data structures
  let output = {
    farmersSet: new Set(),
    totalArea: 0,
    cropMap: {},
    uniqueFarmersDetails: [],
    farmerKhathaSurveyDetails: {}
  };

  const fileInput = document.getElementById('fileInput');
  const dataTable = document.getElementById('dataTable');
  const summaryDiv = document.getElementById('summary');
  const messageDiv = document.getElementById('message');
  const saveSummaryBtn = document.getElementById('saveSummaryBtn');

  // Show upload report
  function showUploadReport(){
    showPage('uploadReportPage');
    populateYearDropdown('cropYear','--Choose Year--');
    fileInput.value = "";
    messageDiv.textContent = "";
    summaryDiv.textContent = "";
    dataTable.innerHTML = "";
  }

  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file){
      messageDiv.textContent = 'No file selected.';
      return;
    }
    messageDiv.style.color = 'black';
    messageDiv.textContent = '';
    summaryDiv.textContent = '';
    dataTable.innerHTML = '';
    output.farmersSet.clear();
    output.totalArea = 0;
    output.cropMap = {};
    output.uniqueFarmersDetails = [];
    output.farmerKhathaSurveyDetails = {};

    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
        if(!jsonData.length){
          messageDiv.style.color = 'red';
          messageDiv.textContent = 'File is empty or has invalid format.';
          return;
        }
        displayData(jsonData);
        summarizeData(jsonData);
      } catch(ex){
        messageDiv.style.color = 'red';
        messageDiv.textContent = 'Error reading file: ' + ex.message;
      }
    };
    reader.readAsArrayBuffer(file);
  });

  function displayData(data){
    if(!data.length) { dataTable.innerHTML = ''; return; }
    const headers = Object.keys(data[0]);
    let html = '<thead><tr>';
    headers.forEach(h => html += `<th>${escapeHtml(h)}</th>`);
    html += '</tr></thead><tbody>';
    data.forEach(row => {
      html += '<tr>';
      headers.forEach(h => html += `<td>${escapeHtml(row[h])}</td>`);
      html += '</tr>';
    });
    html += '</tbody>';
    dataTable.innerHTML = html;
  }

  // Summarize data
  function summarizeData(data){
    output.farmersSet.clear();
    output.totalArea = 0;
    output.cropMap = {};
    const farmerMap = new Map();
    const farmerDetailsMap = new Map();

    data.forEach(row => {
      const aadhaar = (row['Aadhaar Number'] || '').toString().trim();
      const farmerName = (row['Farmer Name'] || '').toString().trim();
      const fatherName = (row['Father Name'] || '').toString().trim();
      const village = (row['Village'] || '').toString().trim();
      const khathaNo = (row['Khatha Number'] || '').toString().trim();
      const surveyNo = (row['Survey Number'] || '').toString().trim();
      const cropName = (row['Crop Name'] || '').toString().trim();
      const bookingID = (row['Booking ID'] || '').toString().trim();
      const area = Number(row['Area Sown']) || 0;

      const key = aadhaar || (farmerName + '|' + village);

      if(key) output.farmersSet.add(key);

      if(key && !farmerMap.has(key)) {
        farmerMap.set(key, { farmerName, fatherName, aadhaarNumber: aadhaar || '-', village });
      }

      if(!farmerDetailsMap.has(key)) {
        farmerDetailsMap.set(key, []);
      }
      farmerDetailsMap.get(key).push({ bookingID, khathaNo, surveyNo, cropName, area });
    });

    output.uniqueFarmersDetails = Array.from(farmerMap.values());

    data.forEach(row => { output.totalArea += Number(row['Area Sown']) || 0; });

    data.forEach(row => {
      const crop = (row['Crop Name'] || 'Unknown').toString().trim();
      const aadhaar = (row['Aadhaar Number'] || '').toString().trim();
      const farmerName = (row['Farmer Name'] || '').toString().trim();
      const village = (row['Village'] || '').toString().trim();
      const farmerKey = aadhaar || (farmerName + '|' + village);

      if(!output.cropMap[crop]) output.cropMap[crop] = { farmers: new Set(), area: 0 };
      output.cropMap[crop].farmers.add(farmerKey);
      output.cropMap[crop].area += Number(row['Area Sown']) || 0;
    });

    output.farmerKhathaSurveyDetails = {};
    farmerDetailsMap.forEach((val,key) => {
      output.farmerKhathaSurveyDetails[key] = val;
    });

    let cropTable = `<table style="margin:1rem auto; border-collapse:collapse; width:90%;">
      <thead><tr>
      <th style="padding:4px 8px; background:#2166c3; color:#fff;">Crop Name</th>
      <th style="padding:4px 8px; background:#2166c3; color:#fff;">Unique Farmers</th>
      <th style="padding:4px 8px; background:#2166c3; color:#fff;">Area Sown</th>
      </tr></thead><tbody>`;

    let totalExtentAllCrops = 0;

    Object.keys(output.cropMap).forEach(crop => {
      const area = output.cropMap[crop].area;
      totalExtentAllCrops += area;
      cropTable += `<tr>
        <td style="padding:4px 8px;">
          <button class="cropNameBtn" data-crop="${encodeURIComponent(crop)}" aria-label="View farmers for crop ${escapeHtml(crop)}" style="background:none; border:none; color:#2166c3; cursor:pointer; text-decoration:underline; padding:0; font-size:inherit;">${escapeHtml(crop)}</button>
        </td>
        <td style="padding:4px 8px;">${output.cropMap[crop].farmers.size}</td>
        <td style="padding:4px 8px;">${area.toFixed(2)}</td>
      </tr>`;
    });
    cropTable += `<tr style="font-weight:bold; background:#eee;">
      <td colspan="2" style="text-align:right; padding-right:8px;">Total Extent of All Crops</td>
      <td>${totalExtentAllCrops.toFixed(2)}</td>
    </tr>`;

    cropTable += '</tbody></table>';

    summaryDiv.innerHTML = `
      <p>Total Unique Farmers: <strong>${output.farmersSet.size}</strong></p>
      <p>Total Area Sown Across All Crops: <strong>${totalExtentAllCrops.toFixed(2)}</strong></p>
      <h4 style="color:#184e8a; margin:1.5rem 0 0 0; text-align:left;">Crop-wise Details:</h4>
      ${cropTable}
    `;
  }

  saveSummaryBtn.addEventListener('click', () => {
    const cropYearInput = document.getElementById('cropYear').value;
    const seasonInput = document.getElementById('season').value;
    if(!cropYearInput) { alert('Please select the Crop Year'); return; }
    if(!seasonInput) { alert('Please select the Season'); return; }
    let allReports = JSON.parse(localStorage.getItem('allReports') || '{}');
    const key = `${cropYearInput}_${seasonInput}`;
    allReports[key] = {
      summary: {
        totalFarmers: output.farmersSet.size,
        totalArea: output.totalArea,
        crops: Object.entries(output.cropMap).map(([crop,v]) => ({
          cropName: crop,
          uniqueFarmers: v.farmers.size,
          areaSown: v.area
        }))
      },
      uniqueFarmers: output.uniqueFarmersDetails,
      farmerDetails: output.farmerKhathaSurveyDetails
    };
    localStorage.setItem('allReports', JSON.stringify(allReports));
    alert(`Report for Crop Year ${cropYearInput} and Season ${seasonInput} saved!\nRedirecting to e-Panta Report...`);
    showEPantaReportByParams(cropYearInput, seasonInput);
  });

  // Pages toggles
  function showEPantaReport() {
    showPage('ePantaReportPage');
    populateYearDropdown('filterYear','--Choose Year--');
    document.getElementById('reportContainer').innerHTML = '';
  }

  function showEPantaReportByParams(year, season) {
    populateYearDropdown('filterYear','--Choose Year--');
    document.getElementById('filterYear').value = year;
    document.getElementById('filterSeason').value = season || '';
    showEPantaReport();
    loadReport();
  }

  ['repNavEPanta','navEPanta','upNavEPanta','fdNavEPanta','cfNavEPanta'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener('click', e => { e.preventDefault(); showEPantaReport(); });
  });

  document.getElementById('loadReportBtn').addEventListener('click', loadReport);

  function getFarmerKey(farmer) {
    const aadhaar = (farmer.aadhaarNumber || '').toString().trim();
    if(aadhaar && aadhaar !== '-') return aadhaar;
    const name = (farmer.farmerName || '').toString().trim();
    const village = (farmer.village || '').toString().trim();
    return `${name}|${village}`.trim();
  }

  function loadReport() {
    const year = document.getElementById('filterYear').value;
    const season = document.getElementById('filterSeason').value;
    const reportContainer = document.getElementById('reportContainer');
    if(!year){ alert('Please select Crop Year'); return; }
    if(!season){ alert('Please select Season'); return; }
    const key = `${year}_${season}`;
    const allReports = JSON.parse(localStorage.getItem('allReports') || '{}');
    const report = allReports[key];
    if(!report){
      alert(`No report found for Crop Year ${year} and Season ${season}.`);
      reportContainer.innerHTML = '';
      return;
    }
    let html = `
      <div class="summary" style="margin-bottom:1rem;">
        <p><strong>Total Unique Farmers:</strong> ${report.summary.totalFarmers}</p>
        <p><strong>Total Area Sown:</strong> ${report.summary.totalArea.toFixed(2)}</p>
      </div>
      <h3>Crop-wise Details</h3>
      <table>
        <thead><tr><th>Crop Name</th><th>Unique Farmers</th><th>Area Sown</th></tr></thead><tbody>`;

    report.summary.crops.forEach(crop =>{
      html += `<tr>
        <td>
          <button class="cropNameBtn" data-crop="${encodeURIComponent(crop.cropName)}" aria-label="View farmers for crop ${escapeHtml(crop.cropName)}">${escapeHtml(crop.cropName)}</button>
        </td>
        <td>${crop.uniqueFarmers}</td>
        <td>${crop.areaSown.toFixed(2)}</td>
      </tr>`;
    });

    const totalAreaSum = report.summary.crops.reduce((acc,c) => acc + c.areaSown, 0);
    html += `<tr style="font-weight:bold; background:#eee;">
      <td colspan="2" style="text-align:right; padding-right:8px;">Total Extent of All Crops</td>
      <td>${totalAreaSum.toFixed(2)}</td>
    </tr>`;
    html += `</tbody></table>`;

    html += `
      <h3>Unique Farmer Details</h3>
      <table>
        <thead><tr><th>Farmer Name</th><th>Father Name</th><th>Aadhaar Number</th></tr></thead><tbody>`;
    report.uniqueFarmers.forEach(farmer => {
      const farmerKey = getFarmerKey(farmer);
      html += `<tr>
          <td><button class="farmerNameBtn" data-key="${encodeURIComponent(farmerKey)}" aria-label="View cultivation details of ${escapeHtml(farmer.farmerName)}">${escapeHtml(farmer.farmerName)}</button></td>
          <td>${escapeHtml(farmer.fatherName)}</td>
          <td>${escapeHtml(farmer.aadhaarNumber)}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    reportContainer.innerHTML = html;
  }

  // Click handlers for farmer & crop names
  document.addEventListener('click', e => {
    if(e.target.classList.contains('farmerNameBtn')){
      const farmerKey = decodeURIComponent(e.target.getAttribute('data-key'));
      const year = document.getElementById('filterYear').value;
      const season = document.getElementById('filterSeason').value;
      if(!year || !season){
        alert('Select Crop Year and Season first.');
        return;
      }
      sessionStorage.setItem('selectedReportKey', `${year}_${season}`);
      sessionStorage.setItem('selectedFarmerKey', farmerKey);
      showFarmerDetailsPage();
    }
    else if(e.target.classList.contains('cropNameBtn')){
      const cropName = decodeURIComponent(e.target.getAttribute('data-crop'));
      const year = document.getElementById('filterYear').value;
      const season = document.getElementById('filterSeason').value;
      if(!year || !season){
        alert('Select Crop Year and Season first.');
        return;
      }
      sessionStorage.setItem('selectedReportKey', `${year}_${season}`);
      sessionStorage.setItem('selectedCropName', cropName);
      showCropFarmersPage();
    }
  });

  // Farmer details page
  function showFarmerDetailsPage(){
    showPage('farmerDetailsPage');
    const reportKey = sessionStorage.getItem('selectedReportKey');
    const farmerKey = sessionStorage.getItem('selectedFarmerKey');
    const title = document.getElementById('farmerDetailsTitle');
    const content = document.getElementById('farmerDetailsContent');
    if(!reportKey || !farmerKey){
      title.textContent = 'Farmer Cultivation Details';
      content.innerHTML = "<p>No farmer details available.</p>";
      return;
    }
    const allReports = JSON.parse(localStorage.getItem('allReports') || '{}');
    const report = allReports[reportKey];
    if(!report || !report.farmerDetails){
      title.textContent = 'Farmer Cultivation Details';
      content.innerHTML = "<p>No detailed report data available.</p>";
      return;
    }
    const details = report.farmerDetails[farmerKey];
    if(!details || !details.length){
      title.textContent = 'Farmer Cultivation Details';
      content.innerHTML = "<p>No cultivation details found for this farmer.</p>";
      return;
    }
    let farmerName = '(Unknown)';
    const uf = report.uniqueFarmers.find(f => getFarmerKey(f) === farmerKey);
    if(uf) farmerName = uf.farmerName;
    title.textContent = `Cultivation Details for Farmer: ${farmerName}`;
    let html = `
      <table>
        <thead>
          <tr><th>Booking ID</th><th>Khatha Number</th><th>Survey Number</th><th>Crop Name</th><th>Area Sown</th></tr>
        </thead><tbody>`;
    details.forEach(d => {
      html += `<tr>
        <td>${escapeHtml(d.bookingID || '-')}</td>
        <td>${escapeHtml(d.khathaNo || '-')}</td>
        <td>${escapeHtml(d.surveyNo || '-')}</td>
        <td>${escapeHtml(d.cropName || '-')}</td>
        <td>${d.area.toFixed(2)}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    content.innerHTML = html;
  }

  document.getElementById('fdBackBtn').addEventListener('click', () => {
    showEPantaReport();
    const key = sessionStorage.getItem('selectedReportKey');
    if(key){
      const [year, season] = key.split('_');
      if(year && season){
        document.getElementById('filterYear').value = year;
        document.getElementById('filterSeason').value = season;
        loadReport();
      }
    }
  });

  // Crop farmers page
  function showCropFarmersPage(){
    showPage('cropFarmersPage');
    const reportKey = sessionStorage.getItem('selectedReportKey');
    const cropName = sessionStorage.getItem('selectedCropName');
    const title = document.getElementById('cropFarmersTitle');
    const content = document.getElementById('cropFarmersContent');

    if(!reportKey || !cropName){
      title.textContent = 'Crop Farmers';
      content.innerHTML = '<p>No crop specified.</p>';
      return;
    }
    const allReports = JSON.parse(localStorage.getItem('allReports') || '{}');
    const report = allReports[reportKey];

    if(!report || !report.farmerDetails){
      title.textContent = 'Crop Farmers';
      content.innerHTML = '<p>No detailed report data available.</p>';
      return;
    }

    const farmerMap = new Map();

    report.uniqueFarmers.forEach(farmer => {
      const farmerKey = getFarmerKey(farmer);
      const details = report.farmerDetails[farmerKey] || [];
      let sumArea = 0;
      details.forEach(d => {
        if(d.cropName === cropName) sumArea += Number(d.area) || 0;
      });
      if(sumArea > 0){
        const key = (farmer.farmerName || '') + '|' + (farmer.fatherName || '');
        farmerMap.set(key, {
          farmerName: farmer.farmerName,
          fatherName: farmer.fatherName,
          sumArea
        });
      }
    });

    title.textContent = `Farmers for Crop: ${cropName}`;

    if(farmerMap.size === 0){
      content.innerHTML = '<p>No farmer found for this crop.</p>';
      return;
    }

    let html = `<table>
      <thead><tr><th>Farmer Name</th><th>Father Name</th><th>Total Area Sown (${escapeHtml(cropName)})</th></tr></thead><tbody>`;
    let grandTotal = 0;
    farmerMap.forEach(f => {
      html += `<tr>
        <td>${escapeHtml(f.farmerName)}</td>
        <td>${escapeHtml(f.fatherName)}</td>
        <td>${f.sumArea.toFixed(2)}</td>
      </tr>`;
      grandTotal += f.sumArea;
    });
    html += `<tr style="font-weight:bold;background:#eee;">
      <td colspan="2" style="text-align:right;">Total Area</td>
      <td>${grandTotal.toFixed(2)}</td>
    </tr></tbody></table>`;
    content.innerHTML = html;
  }

  document.getElementById('cfBackBtn').addEventListener('click', () => {
    showEPantaReport();
    const key = sessionStorage.getItem('selectedReportKey');
    if(key){
      const [year, season] = key.split('_');
      if(year && season){
        document.getElementById('filterYear').value = year;
        document.getElementById('filterSeason').value = season;
        loadReport();
      }
    }
  });

  // Aadhaar search on dashboard
  const aadhaarSearchInput = document.getElementById('aadhaarSearchInput');
  const searchResults = document.getElementById('searchResults');
  const dashboardTiles = document.getElementById('dashboardTiles');

  aadhaarSearchInput.addEventListener('input', () => {
    const val = aadhaarSearchInput.value.trim();
    if(val.length === 0){
      dashboardTiles.style.display = 'flex';
      searchResults.innerHTML = '';
      return;
    }
    if(val.length !== 4 || !/^\d{4}$/.test(val)){
      searchResults.innerHTML = `<p style="color:#555;">Please enter exactly 4 digits.</p>`;
      dashboardTiles.style.display = 'none';
      return;
    }
    const allReports = JSON.parse(localStorage.getItem('allReports') || '{}');
    const matchedFarmersMap = new Map();

    Object.values(allReports).forEach(report => {
      report.uniqueFarmers.forEach(farmer => {
        const aadhaarNum = (farmer.aadhaarNumber || '').toString();
        if(aadhaarNum.endsWith(val)){
          const key = aadhaarNum || ((farmer.farmerName || '') + '|' + (farmer.village || ''));
          if(!matchedFarmersMap.has(key)) {
            matchedFarmersMap.set(key, {
              farmerName: farmer.farmerName,
              fatherName: farmer.fatherName,
              aadhaarNumber: aadhaarNum,
              village: farmer.village,
              totalArea: 0
            });
          }
          const details = report.farmerDetails[key];
          if(details && details.length){
            const areaSum = details.reduce((a,d) => a + (Number(d.area) || 0), 0);
            matchedFarmersMap.get(key).totalArea += areaSum;
          }
        }
      });
    });

    dashboardTiles.style.display = 'none';

    if(matchedFarmersMap.size === 0){
      searchResults.innerHTML = `<p>No farmers found matching Aadhaar ending with '${val}'.</p>`;
      return;
    }

    let html = `<table>
      <thead><tr><th>Farmer Name</th><th>Father Name</th><th>Aadhaar Number</th><th>Village</th><th>Total Area Sown</th></tr></thead><tbody>`;
    matchedFarmersMap.forEach(f => {
      html += `<tr>
        <td>${escapeHtml(f.farmerName)}</td>
        <td>${escapeHtml(f.fatherName)}</td>
        <td>${escapeHtml(f.aadhaarNumber)}</td>
        <td>${escapeHtml(f.village)}</td>
        <td>${f.totalArea.toFixed(2)}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    searchResults.innerHTML = html;
  });

  // On load initialize UI
  window.onload = () => {
    populateYearDropdown('cropYear','--Choose Year--');
    populateYearDropdown('filterYear','--Choose Year--');
    if(localStorage.getItem('loggedIn') === 'yes'){
      showDashboard();
    } else {
      showPage('loginPage');
    }
  };
</script>
</body>
</html>
